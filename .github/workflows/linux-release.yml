name: Build Linux Release
on:
  push:
    tags:
      - 'v*'
jobs:
  build-linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
          
      - name: Enable Linux
        run: flutter config --enable-linux-desktop
        
      - name: Install Infisical CLI
        run: |
          curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash
          sudo apt-get update && sudo apt-get install -y infisical
        
      - name: Fetch secrets from Infisical
        working-directory: ./application/heartcheck_desktop
        env:
          INFISICAL_TOKEN: ${{ secrets.INFISICAL_TOKEN }}
        run: infisical export --env=prod --format=json --token=$INFISICAL_TOKEN --output-file=./secrets-raw.json
        
      - name: Convert Infisical JSON to Flutter-JSON 
        working-directory: ./application/heartcheck_desktop
        run: bash ../convert-infisical-to-flutter.sh
        
      - name: Build Linux App
        working-directory: ./application/heartcheck_desktop
        run: flutter build linux --release --dart-define-from-file=secrets.json --obfuscate --split-debug-info=./debug_info
        
      - name: Remove secrets file
        if: always()
        working-directory: ./application/heartcheck_desktop
        run: rm -f secrets.json
        
      - name: Create tarball
        working-directory: ./application/heartcheck_desktop
        run: |
          cd build/linux/x64/release/bundle
          tar -czf ../../../../../HeartCheck-linux-x64.tar.gz *
        
      - name: Get Release Notes
        id: notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ github.ref_name }}"
          body=$(gh release view $tag --json body --jq .body)
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$body" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        
      - name: Get previous release tag
        id: prev
        run: |
          prev_tag=$(git tag --sort=-creatordate | grep -v "${{ github.ref_name }}" | head -n 1)
          if [ -n "$prev_tag" ]; then
            echo "PREV_TAG=$prev_tag" >> $GITHUB_ENV
            echo "HAS_PREV=true" >> $GITHUB_ENV
          else
            echo "HAS_PREV=false" >> $GITHUB_ENV
          fi
        
      - name: Download previous release
        if: env.HAS_PREV == 'true'
        working-directory: ./application/heartcheck_desktop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download $PREV_TAG -p "HeartCheck-linux-x64.tar.gz" -O prev.tar.gz || echo "No previous x64 release found"
          if [ -f prev.tar.gz ]; then
            mkdir -p prev_bundle
            tar -xzf prev.tar.gz -C prev_bundle
            echo "PREV_EXISTS=true" >> $GITHUB_ENV
          else
            echo "PREV_EXISTS=false" >> $GITHUB_ENV
          fi
        
      - name: Install bsdiff
        run: sudo apt-get install -y bsdiff
        
      - name: Create delta patch
        if: env.HAS_PREV == 'true' && env.PREV_EXISTS == 'true'
        working-directory: ./application/heartcheck_desktop
        run: |
          bsdiff "prev_bundle/heartcheck_desktop" "build/linux/x64/release/bundle/heartcheck_desktop" "HeartCheck-x64-$PREV_TAG-to-${{ github.ref_name }}.patch"
          delta_size=$(stat -c%s "HeartCheck-x64-$PREV_TAG-to-${{ github.ref_name }}.patch")
          echo "DELTA_SIZE=$delta_size" >> $GITHUB_ENV
        
      - name: Generate appcast.xml
        working-directory: ./application/heartcheck_desktop
        run: |
          template=$(cat ../../.github/appcast_template.xml)
          version="${{ github.ref_name }}"
          version="${version#v}"
          full_url="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/HeartCheck-linux-x64.tar.gz"
          full_size=$(stat -c%s "HeartCheck-linux-x64.tar.gz")
          notes="${{ steps.notes.outputs.body }}"
          
          if [ "$HAS_PREV" = "true" ] && [ "$PREV_EXISTS" = "true" ] && [ -n "$DELTA_SIZE" ]; then
            prev_version="${PREV_TAG#v}"
            delta_url="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/HeartCheck-x64-$PREV_TAG-to-$version.patch"
            output=$(echo "$template" | \
              sed "s|{{VERSION}}|$version|g" | \
              sed "s|{{FULL_DOWNLOAD_URL}}|$full_url|g" | \
              sed "s|{{FULL_FILE_SIZE}}|$full_size|g" | \
              sed "s|{{DELTA_DOWNLOAD_URL}}|$delta_url|g" | \
              sed "s|{{DELTA_FILE_SIZE}}|$DELTA_SIZE|g" | \
              sed "s|{{PREVIOUS_VERSION}}|$prev_version|g" | \
              sed "s|{{RELEASE_NOTES}}|$notes|g")
          else
            output=$(echo "$template" | \
              sed "s|{{VERSION}}|$version|g" | \
              sed "s|{{FULL_DOWNLOAD_URL}}|$full_url|g" | \
              sed "s|{{FULL_FILE_SIZE}}|$full_size|g" | \
              sed "s|{{RELEASE_NOTES}}|$notes|g")
          fi
          echo "$output" > appcast-linux-x64.xml
        
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./application/heartcheck_desktop/HeartCheck-linux-x64.tar.gz
            ./application/heartcheck_desktop/HeartCheck-x64-*.patch
            ./application/heartcheck_desktop/appcast-linux-x64.xml

  build-linux-arm64:
    runs-on: ubuntu-24.04-arm64
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
          
      - name: Enable Linux
        run: flutter config --enable-linux-desktop
        
      - name: Install Infisical CLI
        run: |
          curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash
          sudo apt-get update && sudo apt-get install -y infisical
        
      - name: Fetch secrets from Infisical
        working-directory: ./application/heartcheck_desktop
        env:
          INFISICAL_TOKEN: ${{ secrets.INFISICAL_TOKEN }}
        run: infisical export --env=prod --format=json --token=$INFISICAL_TOKEN --output-file=./secrets-raw.json
        
      - name: Convert Infisical JSON to Flutter-JSON 
        working-directory: ./application/heartcheck_desktop
        run: bash ../convert-infisical-to-flutter.sh
        
      - name: Build Linux App
        working-directory: ./application/heartcheck_desktop
        run: flutter build linux --release --dart-define-from-file=secrets.json --obfuscate --split-debug-info=./debug_info
        
      - name: Remove secrets file
        if: always()
        working-directory: ./application/heartcheck_desktop
        run: rm -f secrets.json
        
      - name: Create tarball
        working-directory: ./application/heartcheck_desktop
        run: |
          cd build/linux/arm64/release/bundle
          tar -czf ../../../../../HeartCheck-linux-arm64.tar.gz *
        
      - name: Get Release Notes
        id: notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ github.ref_name }}"
          body=$(gh release view $tag --json body --jq .body)
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$body" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        
      - name: Get previous release tag
        id: prev
        run: |
          prev_tag=$(git tag --sort=-creatordate | grep -v "${{ github.ref_name }}" | head -n 1)
          if [ -n "$prev_tag" ]; then
            echo "PREV_TAG=$prev_tag" >> $GITHUB_ENV
            echo "HAS_PREV=true" >> $GITHUB_ENV
          else
            echo "HAS_PREV=false" >> $GITHUB_ENV
          fi
        
      - name: Download previous release
        if: env.HAS_PREV == 'true'
        working-directory: ./application/heartcheck_desktop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download $PREV_TAG -p "HeartCheck-linux-arm64.tar.gz" -O prev.tar.gz || echo "No previous arm64 release found"
          if [ -f prev.tar.gz ]; then
            mkdir -p prev_bundle
            tar -xzf prev.tar.gz -C prev_bundle
            echo "PREV_EXISTS=true" >> $GITHUB_ENV
          else
            echo "PREV_EXISTS=false" >> $GITHUB_ENV
          fi
        
      - name: Install bsdiff
        run: sudo apt-get install -y bsdiff
        
      - name: Create delta patch
        if: env.HAS_PREV == 'true' && env.PREV_EXISTS == 'true'
        working-directory: ./application/heartcheck_desktop
        run: |
          bsdiff "prev_bundle/heartcheck_desktop" "build/linux/arm64/release/bundle/heartcheck_desktop" "HeartCheck-arm64-$PREV_TAG-to-${{ github.ref_name }}.patch"
          delta_size=$(stat -c%s "HeartCheck-arm64-$PREV_TAG-to-${{ github.ref_name }}.patch")
          echo "DELTA_SIZE=$delta_size" >> $GITHUB_ENV
        
      - name: Generate appcast.xml
        working-directory: ./application/heartcheck_desktop
        run: |
          template=$(cat ../../.github/appcast_template.xml)
          version="${{ github.ref_name }}"
          version="${version#v}"
          full_url="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/HeartCheck-linux-arm64.tar.gz"
          full_size=$(stat -c%s "HeartCheck-linux-arm64.tar.gz")
          notes="${{ steps.notes.outputs.body }}"
          
          if [ "$HAS_PREV" = "true" ] && [ "$PREV_EXISTS" = "true" ] && [ -n "$DELTA_SIZE" ]; then
            prev_version="${PREV_TAG#v}"
            delta_url="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/HeartCheck-arm64-$PREV_TAG-to-$version.patch"
            output=$(echo "$template" | \
              sed "s|{{VERSION}}|$version|g" | \
              sed "s|{{FULL_DOWNLOAD_URL}}|$full_url|g" | \
              sed "s|{{FULL_FILE_SIZE}}|$full_size|g" | \
              sed "s|{{DELTA_DOWNLOAD_URL}}|$delta_url|g" | \
              sed "s|{{DELTA_FILE_SIZE}}|$DELTA_SIZE|g" | \
              sed "s|{{PREVIOUS_VERSION}}|$prev_version|g" | \
              sed "s|{{RELEASE_NOTES}}|$notes|g")
          else
            output=$(echo "$template" | \
              sed "s|{{VERSION}}|$version|g" | \
              sed "s|{{FULL_DOWNLOAD_URL}}|$full_url|g" | \
              sed "s|{{FULL_FILE_SIZE}}|$full_size|g" | \
              sed "s|{{RELEASE_NOTES}}|$notes|g")
          fi
          echo "$output" > appcast-linux-arm64.xml
        
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./application/heartcheck_desktop/HeartCheck-linux-arm64.tar.gz
            ./application/heartcheck_desktop/HeartCheck-arm64-*.patch
            ./application/heartcheck_desktop/appcast-linux-arm64.xml
